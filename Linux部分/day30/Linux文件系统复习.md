# Linux文件复习

### Ep01文件类型

- 普通文件

- 目录文件

  > - 通过目录文件的链接构成的
  > - 本质是链表

- 设备文件

  > - 字符设备文件
  >   - 键盘，鼠标
  > - 块设备文件
  >   - 硬盘，rom

- 管道：FIFO

  > - 不可以打开
  > - 可以建立读写段
  > - 建立半双工通信
  > - 可以用两条管道建立全双工

### Ep02 基于文件指针的操作

- FILE

  > - 文件流（读一个移一个）
  > - 分配再用户空间内，是一个输入输出缓冲区
  > - 本质是利用内核的文件对象和文件描述符

- 打开和关闭

  > - fopen
  >   - w：创建一个新文件
  >   - w+：创建一个新文件并且可读
  >   - r：读取
  >   - r+：可读可写
  >   - a：只允许写（并且偏移到文件末尾）
  >   - a+：可读可写，读写位置再文件开始位置
  >     - 第一次写入时，文件读写偏移到文件末尾
  >     - 多人写入时避免冲突
  > - fclose

- 读写

  > - fread&fwrite
  >   - 适用二进制文件
  >   - 存储空间小
  >   - 不方便人类阅读

- 文件定位

  > - fseek：偏移读写位置
  > - ftell：获取当前读取位置
  > - rewind：fseek(fp,0)

- 修改文件再文件系统的信息

  > - 权限管理：chmod
  >   - mode t 实际是整形，通过他的位信息来确定文件权限
  > - 查看文件信息：stat
  >   - nlink：硬链接数量
  >   - uid/gid：用户id/组id
  >   - size：文件大小
  >   - ctime — 最后一次修改内节点状态的时间
  >   - mtime — 最后一次修改文件（或者目录）数据的时间
  >   - atime — 最后一次访问文件（或者目录）数据的时间

###  Ep03 ：目录相关操作

  - 目录的本质的一个链表，也是一个文件 

    > - 这是目录中每一个文件的节点: struct dirent
    >
    >   ```c
    >   struct dirent{
    >       inode;    //磁盘地址
    >       off;	  //到下一个节点的位置（next）
    >       reclen;   //本节点的长度
    >       type; 	  //文件类型
    >       name;	  //文件名
    >    };
    >   ```
    >
    > - 其中硬盘地址为硬链接
    >
    >   - 可多个文件共享磁盘内容
    >   - 磁盘内容和文件构成了引用计数的关系
    >   - 当引用计数>1时，减少引用计数不影响磁盘内容
    >   - 当引用计数=1时，减少引用会直接是否文件内容

   - 当前工作目录：~~pwd~~

     > - 决定了相对路径的起始位置
     > - 当前工作目录+相对路径=绝对路径

  - 获取当前目录：getcwd

    > - getcwd(bud,size); ：容易溢出
    > - getcwd(NULL,0);   ：自动分配堆空间，存放路径

  - 改变当前工作目录：chdir

     > - 改变当前子进程的工作目录，不会影响到父进程（shell进程）

   - 创建空目录：mkdir

     > - 指定权限的时候会受到掩码的影响

   - 删除空目录：rmdir（只能删除空目录)
  
   - 目录流：DIR，读写位置从头开始，每次访问dirent节点的时候读写向后偏移。（相当于每次readdir，链表自动访问下一个节点）

     > - 打开和关闭
     >   - opendir：根据文件内容创建一个目录流
     >   - closedir：关闭
     > - 读取：readdir
     >   - 每次读取向后偏移（相当于每次readdir，链表自动访问下一个节点）
     >   - 每次readdir是时候结果不同
     >   - readdir == NULL时，读到尾部
     > - 偏移读写位置
     >   - telldir：获取当前读写位置
     >   - seekdir：转移到某个读写位置（偏移指针）
     >   - rewinddir：将读写位置回到开始



### Ep03：文件描述符

- 内核内的一个数组，数组内容是文件对象的地址，文件描述符就是数组下标。（一般为0~1023）即1024个长度

- 打开创建和关闭

  > - open：open("file",flags);
  >   - O_RDONLY：只读
  >   - O_WRONLY：只写
  >   - O_RDWR：可读可写
  >   
  > - open：open("file",flags,0666);也会受掩码影响
  >   - O_CREAT：创建
  >   - O_EXCL：文件存在，open失败
  >   - O_TRUNC：文件存在，内容清空
  >   
  > - 读写：read/write
  >
  >   - 由于read，write是系统调用，需要切换到内核态菜能执行
  >   - 所以buf需要设计的大一点
  >   - 返回值为读取数量，-1时为报错
  >
  > - 改变文件大小：ftruncate
  >
  >   - 变大：补0
  >   - 变小：截断
  >
  > - 文件映射：利用DMA设备，直接在内存二号磁盘中交换文件
  >
  >   - mmap：在堆空间建立固定大小的区域（可以理解为一个固定大小的动态数组）
  >   - 在区域内读写会影响磁盘内容
  >
  > - 改变文件读写位置：lseek
  >
  > - 获取文件信息：fstat
  >
  > - **文件描述符的复制**：多个文件描述符指向同一个文件对象（数组中的不同元素，存放了相同文件对象的地址）
  >
  >   - dup：自动分配一个文件描述符，指向旧文件描述符所指的文件对象
  >   - dup2：指定一个文件描述符，指向旧文件描述符所指的文件对象（若这个文件描述符有其他的指向则关闭）
  >   - 文件对象和文件描述符之间也是引用计数的关系（遵循引用计数的原理）
  >   - 利用dup可以实现重定向
  >
  > - 文件描述符和文件流的关系：文件流利用了文件描述符
  >
  >   - fdopen：根据文件描述符，创建文件流
  >   - flleno：获取文件流的文件描述符
  >
  > - IO多路复用：将所有需要等待的文件描述符集中，一起等待
  >
  >   - select：流程
  >   - 创建等待集合：fd_set /FD_ZERO(初始化)
  >   - 将需要等待的集合加入监听：FD_SET
  >   - 使用select进入等待状态
  >     - 一旦集合中有一个文件描述符就绪，select就会恢复就绪的状态（不再等待）
  >   - 检查文件描述符的就绪状态（需要一个一个检查）
  >     - FD_ISSET
  >   - 超时机制：利用select的返回值，查看文件描述符是否就绪
  >   - 写入也会导致阻塞
  >